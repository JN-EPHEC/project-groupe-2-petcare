rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction helper pour vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Fonction helper pour vérifier si l'utilisateur est propriétaire du document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Fonction helper pour vérifier le rôle de l'utilisateur
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Règles pour la collection users
    match /users/{userId} {
      // Lecture: utilisateur lui-même, vets, ou admins
      allow read: if isOwner(userId) || hasRole('vet') || hasRole('admin');
      
      // Écriture: utilisateur lui-même ou admin
      allow write: if isOwner(userId) || hasRole('admin');
    }
    
    // Règles pour la collection pets
    match /pets/{petId} {
      // Lecture: propriétaire, vets, ou admins
      allow read: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Écriture: propriétaire ou admin
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection health_records
    match /health_records/{recordId} {
      // Lecture: propriétaire, vets, ou admins
      allow read: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Écriture: propriétaire, vets, ou admin
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        hasRole('vet') || 
                        hasRole('admin'));
      allow update, delete: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
    }
    
    // Règles pour la collection vaccinations
    match /vaccinations/{vaccinationId} {
      // Lecture: propriétaire, vets, ou admins
      allow read: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Écriture: vets ou admin
      allow write: if hasRole('vet') || hasRole('admin');
    }
    
    // Règles pour la collection reminders
    match /reminders/{reminderId} {
      // Lecture: propriétaire ou admin
      allow read: if isOwner(resource.data.ownerId) || hasRole('admin');
      
      // Écriture: propriétaire ou admin
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection appointments
    match /appointments/{appointmentId} {
      // Lecture: propriétaire, vétérinaire concerné, ou admin
      allow read: if isOwner(resource.data.ownerId) || 
                     isOwner(resource.data.vetId) || 
                     hasRole('admin');
      
      // Création: propriétaire ou vétérinaire
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        request.resource.data.vetId == request.auth.uid);
      
      // Modification: propriétaire, vétérinaire concerné, ou admin
      allow update: if isOwner(resource.data.ownerId) || 
                       isOwner(resource.data.vetId) || 
                       hasRole('admin');
      
      // Suppression: propriétaire ou admin
      allow delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection documents
    match /documents/{documentId} {
      // Lecture: propriétaire, vets, ou admin
      allow read: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Écriture: propriétaire ou admin
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection vets (vétérinaires approuvés)
    match /vets/{vetId} {
      // Lecture: tout le monde (pour trouver des vétérinaires)
      allow read: if true;
      
      // Écriture: admin uniquement
      allow write: if hasRole('admin');
    }
    
    // Règles pour la collection vet_requests (demandes de validation)
    match /vet_requests/{requestId} {
      // Lecture: demandeur ou admin
      allow read: if isOwner(resource.data.userId) || hasRole('admin');
      
      // Création: utilisateurs authentifiés
      allow create: if isAuthenticated();
      
      // Modification/Suppression: admin uniquement
      allow update, delete: if hasRole('admin');
    }
    
    // Par défaut, tout refuser
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

