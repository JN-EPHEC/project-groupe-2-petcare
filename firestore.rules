rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction helper pour vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Fonction helper pour vérifier si l'utilisateur est propriétaire du document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Fonction helper pour vérifier le rôle de l'utilisateur
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Règles pour la collection users
    match /users/{userId} {
      // Lecture: 
      // - Tous les utilisateurs authentifiés peuvent lire les profils
      // (nécessaire pour la recherche de vétérinaires et les fonctionnalités sociales)
      allow read: if isAuthenticated();
      
      // Création/Modification: utilisateur lui-même ou admin
      allow create, update: if isOwner(userId) || hasRole('admin');
      
      // Suppression: utilisateur lui-même ou admin (pour permettre la suppression du compte)
      allow delete: if isOwner(userId) || hasRole('admin');
    }
    
    // Règles pour la collection pets
    match /pets/{petId} {
      // Lecture: propriétaire, vétérinaire attitré (via vetId), tous les vets, ou admins
      allow read: if isOwner(resource.data.ownerId) || 
                     (hasRole('vet') && resource.data.vetId == request.auth.uid) ||
                     hasRole('vet') || 
                     hasRole('admin');
      
      // Écriture: propriétaire ou admin
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection health_records
    match /health_records/{recordId} {
      // Lecture: propriétaire, vets, ou admins
      allow read: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Création: propriétaire, vets, ou admin
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Modification: propriétaire, vets, ou admin
      allow update: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Suppression: propriétaire (via ownerId OU si le pet appartient à l'utilisateur), vets, ou admin
      allow delete: if isOwner(resource.data.ownerId) || 
                       (isAuthenticated() && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                       hasRole('vet') || 
                       hasRole('admin');
    }
    
    // Règles pour la collection vaccinations
    match /vaccinations/{vaccinationId} {
      // Lecture: propriétaire (via ownerId OU si le pet lui appartient), vets, ou admins
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                      hasRole('vet') || 
                      hasRole('admin'));
      
      // Création: propriétaire (via ownerId), vets, ou admin
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Modification: propriétaire (via ownerId OU si le pet lui appartient), vets, ou admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Suppression: propriétaire (via ownerId OU si le pet appartient à l'utilisateur), vets, ou admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('vet') || 
                        hasRole('admin'));
    }
    
    // Règles pour la collection treatments (traitements)
    match /treatments/{treatmentId} {
      // Lecture: propriétaire (via ownerId OU si le pet lui appartient), vets, ou admins
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                      hasRole('vet') || 
                      hasRole('admin'));
      
      // Création: propriétaire (via ownerId), vets, ou admin
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Modification: propriétaire (via ownerId OU si le pet lui appartient), vets, ou admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Suppression: propriétaire (via ownerId OU si le pet appartient à l'utilisateur), vets, ou admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('vet') || 
                        hasRole('admin'));
    }
    
    // Règles pour la collection medicalHistory (historique médical)
    match /medicalHistory/{historyId} {
      // Lecture: propriétaire (via ownerId OU si le pet lui appartient), vets, ou admins
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                      hasRole('vet') || 
                      hasRole('admin'));
      
      // Création: propriétaire (via ownerId), vets, ou admin
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Modification: propriétaire (via ownerId OU si le pet lui appartient), vets, ou admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('vet') || 
                        hasRole('admin'));
      
      // Suppression: propriétaire (via ownerId OU si le pet appartient à l'utilisateur), vets, ou admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('vet') || 
                        hasRole('admin'));
    }
    
    // Règles pour la collection wellnessTracking (suivi bien-être)
    match /wellnessTracking/{entryId} {
      // Lecture: propriétaire (via ownerId OU si le pet lui appartient) ou admin
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                      hasRole('admin'));
      
      // Création: propriétaire uniquement
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Modification: propriétaire (via ownerId OU si le pet lui appartient) ou admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('admin'));
      
      // Suppression: propriétaire (via ownerId OU si le pet lui appartient) ou admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('admin'));
    }
    
    // Règles pour la collection wellnessAlerts (alertes bien-être)
    match /wellnessAlerts/{alertId} {
      // Lecture: propriétaire (via ownerId OU si le pet lui appartient) ou admin
      allow read: if isAuthenticated() &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                      hasRole('admin'));
      
      // Création: propriétaire uniquement (créées automatiquement par le système)
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Modification: propriétaire (via ownerId OU si le pet lui appartient) ou admin
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('admin'));
      
      // Suppression: propriétaire (via ownerId OU si le pet lui appartient) ou admin
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                        hasRole('admin'));
    }
    
    // Règles pour la collection reminders
    match /reminders/{reminderId} {
      // Lecture: propriétaire ou admin
      allow read: if isOwner(resource.data.ownerId) || hasRole('admin');
      
      // Écriture: propriétaire ou admin
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection appointments
    match /appointments/{appointmentId} {
      // Lecture: propriétaire, vétérinaire concerné, ou admin
      allow read: if isOwner(resource.data.ownerId) || 
                     isOwner(resource.data.vetId) || 
                     hasRole('admin');
      
      // Création: propriétaire ou vétérinaire
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        request.resource.data.vetId == request.auth.uid);
      
      // Modification: propriétaire, vétérinaire concerné, ou admin
      allow update: if isOwner(resource.data.ownerId) || 
                       isOwner(resource.data.vetId) || 
                       hasRole('admin');
      
      // Suppression: propriétaire ou admin
      allow delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Règles pour la collection documents
    match /documents/{documentId} {
      // Lecture: propriétaire, vets, ou admin
      allow read: if isOwner(resource.data.ownerId) || hasRole('vet') || hasRole('admin');
      
      // Création: propriétaire ou admin
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      
      // Modification: propriétaire ou admin
      allow update: if isOwner(resource.data.ownerId) || hasRole('admin');
      
      // Suppression: propriétaire (via ownerId OU si le pet appartient à l'utilisateur) ou admin
      allow delete: if isOwner(resource.data.ownerId) || 
                       (isAuthenticated() && resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid) ||
                       hasRole('admin');
    }
    
    // Règles pour la collection vets (vétérinaires approuvés)
    match /vets/{vetId} {
      // Lecture: tout le monde (pour trouver des vétérinaires)
      allow read: if true;
      
      // Écriture: admin uniquement
      allow write: if hasRole('admin');
    }
    
    // Règles pour la collection vet_requests (demandes de validation)
    match /vet_requests/{requestId} {
      // Lecture: demandeur ou admin
      allow read: if isOwner(resource.data.userId) || hasRole('admin');
      
      // Création: utilisateurs authentifiés
      allow create: if isAuthenticated();
      
      // Modification: admin uniquement
      allow update: if hasRole('admin');
      
      // Suppression: demandeur (pour suppression de compte) ou admin
      allow delete: if isOwner(resource.data.userId) || 
                       isOwner(resource.data.vetId) || 
                       hasRole('admin');
    }
    
    // Règles pour la collection subscriptions (Abonnements Premium)
    match /subscriptions/{subscriptionId} {
      // Lecture: utilisateur propriétaire ou admin
      allow read: if isOwner(resource.data.userId) || hasRole('admin');
      
      // Création: utilisateur authentifié pour son propre abonnement
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Modification: admin uniquement (ou système)
      allow update: if hasRole('admin');
      
      // Suppression: admin uniquement
      allow delete: if hasRole('admin');
    }
    
    // ========================================
    // Règles pour Stripe Extension Firebase
    // ========================================
    
    // Règles pour les customers Stripe (gestion des paiements)
    match /customers/{uid} {
      // Lecture: utilisateur lui-même uniquement
      allow read: if request.auth.uid == uid;

      // Checkout sessions (création de sessions de paiement)
      match /checkout_sessions/{id} {
        allow read, write: if request.auth.uid == uid;
      }
      
      // Subscriptions Stripe (abonnements actifs)
      match /subscriptions/{id} {
        allow read: if request.auth.uid == uid;
      }
      
      // Payments (historique des paiements)
      match /payments/{id} {
        allow read: if request.auth.uid == uid;
      }
    }

    // Règles pour les produits Stripe (lecture publique pour affichage)
    match /products/{id} {
      allow read: if true;

      // Prix des produits
      match /prices/{id} {
        allow read: if true;
      }

      // Taux de taxe
      match /tax_rates/{id} {
        allow read: if true;
      }
    }
    
    // ========================================
    // Règles pour les articles de blog Premium
    // ========================================
    match /blog_articles/{articleId} {
      // Lecture: tous (même non authentifiés pour la démo)
      allow read: if true;
      
      // Écriture: admins uniquement (TEMPORAIREMENT: true pour le seed)
      allow create: if true; // TODO: remettre hasRole('admin') après le seed
      allow update, delete: if hasRole('admin');
    }
    
    // ========================================
    // Règles pour le partage sécurisé des carnets d'animaux
    // ========================================
    match /sharedPets/{shareId} {
      // Lecture: propriétaire de l'animal ou utilisateur avec le token
      allow read: if isAuthenticated() && 
                     (isOwner(resource.data.ownerId) || 
                      request.auth.uid == resource.data.sharedWithUserId);
      
      // Création: propriétaire de l'animal uniquement
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Modification: propriétaire de l'animal uniquement
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      // Suppression: propriétaire (via ownerId OU si le pet appartient à l'utilisateur)
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid ||
                        (resource.data.petId != null && get(/databases/$(database)/documents/pets/$(resource.data.petId)).data.ownerId == request.auth.uid));
    }
    
    // ========================================
    // Règles pour les notifications
    // ========================================
    match /notifications/{notificationId} {
      // Lecture: utilisateur destinataire de la notification uniquement
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Création: tous les utilisateurs authentifiés (pour envoyer des notifications)
      allow create: if isAuthenticated();
      
      // Modification: utilisateur destinataire uniquement (pour marquer comme lu)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Suppression: utilisateur destinataire ou admin
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || 
                       hasRole('admin');
    }
    
    // ========================================
    // Règles pour les horaires des vétérinaires
    // ========================================
    match /vetSchedules/{vetId} {
      // Lecture: tous les utilisateurs authentifiés (pour voir les disponibilités)
      allow read: if isAuthenticated();
      
      // Création/Modification: vétérinaire lui-même uniquement
      // Le vetId dans le path doit correspondre à l'UID de l'utilisateur connecté
      allow create, update: if isAuthenticated() && 
                               hasRole('vet') && 
                               vetId == request.auth.uid;
      
      // Suppression: vétérinaire lui-même ou admin
      allow delete: if (isAuthenticated() && 
                        hasRole('vet') && 
                        vetId == request.auth.uid) || 
                       hasRole('admin');
    }
    
    // Règles pour les demandes d'assignation d'animaux aux vétérinaires
    // ==================================================================
    match /petAssignmentRequests/{requestId} {
      // Lecture: propriétaire ou vétérinaire concerné ou admin
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || 
                      resource.data.vetId == request.auth.uid || 
                      hasRole('admin'));
      
      // Création: propriétaire uniquement (création de demande)
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Modification: vétérinaire concerné (pour accepter/refuser) OU propriétaire (pour annuler)
      allow update: if isAuthenticated() && 
                       ((hasRole('vet') && resource.data.vetId == request.auth.uid) ||
                        (resource.data.ownerId == request.auth.uid && request.resource.data.status == 'cancelled'));
      
      // Suppression: propriétaire, vétérinaire concerné ou admin
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || 
                        resource.data.vetId == request.auth.uid || 
                        hasRole('admin'));
    }
    
    // Par défaut, tout refuser
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

